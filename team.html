<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Dashboard | TodoTask Pro Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4A90E2;
      --primary-dark: #2F6BB1;
      --bg-light: #F7F7F8;
      --bg-dark: #1B1D23;
      --card-light: #FFFFFF;
      --card-dark: #242731;
      --text-dark: #2B2B2B;
      --text-light: #EAEAEA;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      transition: background 0.5s, color 0.5s;
    }
    body.dark { background: var(--bg-dark); color: var(--text-light); }

    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 15px 30px; background: var(--card-light);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    body.dark .navbar { background: var(--card-dark); }

    .container { max-width: 1200px; margin: 30px auto; padding: 20px; }

    h2, h3 { color: var(--primary); }

    select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
      font-size: 15px;
    }

    .chart-box {
      background: var(--card-light);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    body.dark .chart-box { background: var(--card-dark); }

    table {
      width: 100%; border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);
      text-align: left;
    }
    th {
      background: var(--primary);
      color: white;
    }

    .logout {
      background: #888;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      table { font-size: 14px; }
    }
  </style>
</head>

<body>
  <div class="navbar">
    <h2>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏°</h2>
    <div>
      <button class="logout" onclick="logout()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button onclick="toggleTheme()">üåó</button>
    </div>
  </div>

  <div class="container">
    <h3>üë• ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°</h3>
    <select id="teamSelect" onchange="filterTeam()">
      <option value="all">‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡∏°</option>
      <option value="teamA">‡∏ó‡∏µ‡∏° A</option>
      <option value="teamB">‡∏ó‡∏µ‡∏° B</option>
      <option value="teamC">‡∏ó‡∏µ‡∏° C</option>
    </select>

    <div class="chart-box">
      <h3>üìà ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏µ‡∏°</h3>
      <canvas id="teamChart"></canvas>
    </div>

    <div class="chart-box">
      <h3>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏°</h3>
      <table id="teamTable">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
            <th>‡∏ó‡∏µ‡∏°</th>
            <th>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
            <th>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à</th>
            <th>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
      authDomain: "my-todo-list-9d2fa.firebaseapp.com",
      projectId: "my-todo-list-9d2fa",
      storageBucket: "my-todo-list-9d2fa.appspot.com",
      messagingSenderId: "631403892452",
      appId: "1:631403892452:web:66d382bf5f143fc05de6f1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.toggleTheme = () => document.body.classList.toggle("dark");
    window.logout = async () => { await signOut(auth); location.href = "index.html"; };

    onAuthStateChanged(auth, (user) => {
      if (!user) location.href = "index.html";
      else loadTeamData();
    });

    let allData = [], chart;

    async function loadTeamData() {
      const usersSnap = await getDocs(collection(db, "users"));
      const tasksSnap = await getDocs(collection(db, "tasks"));

      const summary = {};

      usersSnap.forEach(u => {
        const user = u.data();
        if (!user.team) user.team = "teamA"; // ‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡∏ó‡∏µ‡∏°
        const userTasks = tasksSnap.docs.filter(t => t.data().userId === u.id);
        const done = userTasks.filter(t => t.data().completed).length;
        const total = userTasks.length;
        const percent = total ? Math.round((done / total) * 100) : 0;

        summary[u.id] = { email: user.email, team: user.team, done, total, percent };
      });

      allData = Object.values(summary);
      renderTable(allData);
      renderChart(allData);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#teamTable tbody");
      tbody.innerHTML = "";
      data.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.email}</td>
          <td>${d.team}</td>
          <td>${d.total}</td>
          <td>${d.done}</td>
          <td>${d.percent}%</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderChart(data) {
      if (chart) chart.destroy();

      const teams = {};
      data.forEach(d => {
        if (!teams[d.team]) teams[d.team] = { done: 0, total: 0 };
        teams[d.team].done += d.done;
        teams[d.team].total += d.total;
      });

      const labels = Object.keys(teams);
      const values = labels.map(t => {
        const tData = teams[t];
        return tData.total ? Math.round((tData.done / tData.total) * 100) : 0;
      });

      chart = new Chart(document.getElementById("teamChart"), {
        type: "bar",
        data: {
          labels,
          datasets: [{ label: "‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏°", data: values, backgroundColor: "#4A90E2" }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    window.filterTeam = () => {
      const team = document.getElementById("teamSelect").value;
      const filtered = team === "all" ? allData : allData.filter(d => d.team === team);
      renderTable(filtered);
      renderChart(filtered);
    };
  </script>
</body>
</html>
