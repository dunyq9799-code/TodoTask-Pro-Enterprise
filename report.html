<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reports & Analytics | Task Management System</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{box-sizing:border-box;font-family:"Kanit",sans-serif;transition:all .3s ease;}
:root{
 --violet:#715aff;
 --bg-light:#f4f4f7;
 --bg-dark:#0d0d12;
 --card-light:#fff;
 --card-dark:#1a1a24;
 --text-light:#0d0d12;
 --text-dark:#f4f4f7;
}
body{margin:0;background:var(--bg-light);color:var(--text-light);}
body.dark{background:var(--bg-dark);color:var(--text-dark);}
header{
 display:flex;justify-content:space-between;align-items:center;
 background:var(--card-light);padding:10px 20px;box-shadow:0 0 8px rgba(0,0,0,.15);
 position:sticky;top:0;z-index:100;
}
body.dark header{background:var(--card-dark);}
header h1{color:var(--violet);margin:0;}
#toggleMode{background:none;border:none;font-size:22px;cursor:pointer;color:inherit;}
#backBtn{background:var(--violet);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;}
#sidebar{
 width:220px;position:fixed;top:60px;bottom:0;left:0;background:var(--card-light);
 box-shadow:2px 0 8px rgba(0,0,0,.1);overflow-y:auto;
}
body.dark #sidebar{background:var(--card-dark);}
#sidebar ul{list-style:none;margin:0;padding:0;}
#sidebar li{padding:15px;cursor:pointer;display:flex;align-items:center;}
#sidebar li:hover{background:rgba(113,90,255,.15);}
#sidebar li.active{background:rgba(113,90,255,.3);}
#sidebar span{margin-left:10px;}
main{margin-left:220px;padding:20px;}
.card{background:var(--card-light);padding:20px;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);margin-bottom:20px;}
body.dark .card{background:var(--card-dark);}
.flex{display:flex;flex-wrap:wrap;gap:15px;}
.flex .card{flex:1;min-width:200px;text-align:center;}
canvas{max-width:100%;height:auto;}
button.primary{background:var(--violet);color:#fff;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;margin:5px;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;text-align:left;}
th{background:var(--violet);color:#fff;}
.toast{position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:10px 16px;border-radius:8px;opacity:0;transition:opacity .3s;z-index:9999;}
.toast.show{opacity:1;}
@media(max-width:768px){
 #sidebar{position:fixed;left:-220px;transition:left .3s;}
 #sidebar.open{left:0;}
 main{margin-left:0;}
}
</style>
</head>
<body>
<header>
 <h1>Reports & Analytics</h1>
 <div>
   <button id="toggleMode">üåô</button>
   <span id="userName" style="margin:0 10px;font-weight:600;"></span>
   <button id="backBtn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Dashboard</button>
 </div>
</header>

<div id="sidebar">
 <ul>
   <li class="active" data-page="overview">üìä<span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></li>
   <li data-page="my">üë§<span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span></li>
   <li data-page="team">üë•<span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏°</span></li>
   <li data-page="org">üßæ<span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</span></li>
   <li data-page="export">üíæ<span>Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</span></li>
 </ul>
</div>

<main>
 <!-- Overview -->
 <section id="overview" class="page">
   <div class="flex">
     <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p id="totalTasks">0</p></div>
     <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h3><p id="doneTasks">0</p></div>
     <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h3><p id="pendingTasks">0</p></div>
     <div class="card"><h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h3><p id="overdueTasks">0</p></div>
   </div>
   <div class="card"><canvas id="pieChart"></canvas></div>
   <div class="card"><canvas id="barChart"></canvas></div>
 </section>

 <!-- My Reports -->
 <section id="my" class="page" style="display:none;">
   <div class="card"><h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h2>
     <p>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: <span id="myDone">0</span></p>
     <p>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: <span id="myPending">0</span></p>
     <p>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î: <span id="myOverdue">0</span></p>
     <canvas id="myChart"></canvas><br>
     <button id="exportMyPDF" class="primary">üìÑ Export PDF</button>
   </div>
 </section>

 <!-- Team Reports -->
 <section id="team" class="page" style="display:none;">
   <div class="card"><h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏°</h2>
     <table id="teamTable"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</th><th>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</th><th>‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th></tr></thead><tbody></tbody></table>
     <canvas id="teamChart"></canvas>
   </div>
 </section>

 <!-- Organization Reports -->
 <section id="org" class="page" style="display:none;">
   <div class="card"><h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</h2>
     <canvas id="orgChart"></canvas><br>
     <table id="orgTable"><thead><tr><th>‡∏ó‡∏µ‡∏°</th><th>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</th><th>‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th></tr></thead><tbody></tbody></table>
     <button id="exportOrgPDF" class="primary">üìÑ Export PDF</button>
     <button id="exportExcel" class="primary">üìä Export Excel</button>
   </div>
 </section>

 <!-- Export -->
 <section id="export" class="page" style="display:none;">
   <div class="card"><h2>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
     <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:</p>
     <button id="btnExportPDF" class="primary">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</button>
     <button id="btnExportExcel" class="primary">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
   </div>
 </section>
</main>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
 authDomain:"my-todo-list-9d2fa.firebaseapp.com",
 projectId:"my-todo-list-9d2fa",
 storageBucket:"my-todo-list-9d2fa.appspot.com",
 messagingSenderId:"631403892452",
 appId:"1:631403892452:web:66d382bf5f143fc05de6f1"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

// Toast
const toast=document.getElementById("toast");
function showToast(msg,color="#333"){toast.textContent=msg;toast.style.background=color;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}

// Theme
const body=document.body,toggle=document.getElementById("toggleMode");
if(localStorage.getItem("theme")==="dark"){body.classList.add("dark");toggle.textContent="‚òÄÔ∏è";}
toggle.onclick=()=>{body.classList.toggle("dark");toggle.textContent=body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";localStorage.setItem("theme",body.classList.contains("dark")?"dark":"light");};

// Navigation
document.querySelectorAll("#sidebar li").forEach(li=>{
 li.onclick=()=>{
   document.querySelectorAll("#sidebar li").forEach(x=>x.classList.remove("active"));
   li.classList.add("active");
   document.querySelectorAll(".page").forEach(p=>p.style.display="none");
   document.getElementById(li.dataset.page).style.display="block";
 };
});

// Back
document.getElementById("backBtn").onclick=()=>window.location.href="index.html";

// Charts
let pieChart,barChart,myChart,teamChart,orgChart;

// Load data
let currentUserId=null,userRole="user";
onAuthStateChanged(auth,async user=>{
 if(!user){window.location.href="login.html";return;}
 currentUserId=user.uid;
 const users=await getDocs(collection(db,"users"));
 users.forEach(u=>{if(u.id===user.uid){userRole=u.data().role||"user";document.getElementById("userName").textContent=u.data().name||user.email;}});
 loadReports();
});

async function loadReports(){
 const tasksSnap=await getDocs(collection(db,"tasks"));
 const tasks=tasksSnap.docs.map(d=>({id:d.id,...d.data()}));
 if(!tasks.length){showToast("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô","orange");return;}

 const total=tasks.length;
 const done=tasks.filter(t=>t.status==="done").length;
 const pending=tasks.filter(t=>t.status!=="done").length;
 const overdue=tasks.filter(t=>t.deadline && new Date(t.deadline)<new Date() && t.status!=="done").length;

 document.getElementById("totalTasks").textContent=total;
 document.getElementById("doneTasks").textContent=done;
 document.getElementById("pendingTasks").textContent=pending;
 document.getElementById("overdueTasks").textContent=overdue;

 // Overview charts
 const ctx1=document.getElementById("pieChart");
 if(pieChart)pieChart.destroy();
 pieChart=new Chart(ctx1,{type:"pie",data:{labels:["‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß","‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á","‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î"],datasets:[{data:[done,pending,overdue],backgroundColor:["#715aff","#ffcc00","#ff6666"]}]}});
 const months=Array(12).fill(0);
 tasks.forEach(t=>{if(t.createdAt?.seconds){const m=new Date(t.createdAt.seconds*1000).getMonth();months[m]++;}});
 const ctx2=document.getElementById("barChart");
 if(barChart)barChart.destroy();
 barChart=new Chart(ctx2,{type:"bar",data:{labels:["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."],datasets:[{label:"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô",data:months,backgroundColor:"#715aff"}]}});

 // My reports
 const myTasks=tasks.filter(t=>t.ownerUid===currentUserId);
 const myDone=myTasks.filter(t=>t.status==="done").length;
 const myPending=myTasks.filter(t=>t.status!=="done").length;
 const myOverdue=myTasks.filter(t=>t.deadline && new Date(t.deadline)<new Date() && t.status!=="done").length;
 document.getElementById("myDone").textContent=myDone;
 document.getElementById("myPending").textContent=myPending;
 document.getElementById("myOverdue").textContent=myOverdue;
 const ctxMy=document.getElementById("myChart");
 if(myChart)myChart.destroy();
 myChart=new Chart(ctxMy,{type:"bar",data:{labels:["‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß","‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á","‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î"],datasets:[{data:[myDone,myPending,myOverdue],backgroundColor:["#00cc99","#ffcc00","#ff6666"]}]}});

 // Team reports
 const teamsSnap=await getDocs(collection(db,"teams"));
 const tbody=document.querySelector("#teamTable tbody");
 tbody.innerHTML="";
 const teamNames=[],teamTotals=[],teamDones=[];
 teamsSnap.forEach(team=>{
   const tdata=team.data();
   const teamTasks=tasks.filter(x=>x.teamId===tdata.name);
   const total=teamTasks.length;
   const done=teamTasks.filter(x=>x.status==="done").length;
   const over=teamTasks.filter(x=>x.deadline && new Date(x.deadline)<new Date() && x.status!=="done").length;
   tbody.innerHTML+=`<tr><td>${tdata.name}</td><td>${total}</td><td>${done}</td><td>${over}</td></tr>`;
   teamNames.push(tdata.name);teamTotals.push(total);teamDones.push(done);
 });
 const ctxTeam=document.getElementById("teamChart");
 if(teamChart)teamChart.destroy();
 teamChart=new Chart(ctxTeam,{type:"bar",data:{labels:teamNames,datasets:[{label:"‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",data:teamTotals,backgroundColor:"#715aff"},{label:"‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",data:teamDones,backgroundColor:"#00cc99"}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});

 // Org reports (admin/super)
 if(userRole!=="admin"&&userRole!=="super"){document.getElementById("org").style.display="none";return;}
 const tbodyOrg=document.querySelector("#orgTable tbody");
 tbodyOrg.innerHTML="";
 teamNames.forEach((n,i)=>{tbodyOrg.innerHTML+=`<tr><td>${n}</td><td>${teamTotals[i]}</td><td>${teamDones[i]}</td><td>${teamTotals[i]-teamDones[i]}</td></tr>`;});
 const ctxOrg=document.getElementById("orgChart");
 if(orgChart)orgChart.destroy();
 orgChart=new Chart(ctxOrg,{type:"line",data:{labels:teamNames,datasets:[{label:"‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",data:teamDones,borderColor:"#00cc99",fill:false},{label:"‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",data:teamTotals,borderColor:"#715aff",fill:false}]}});

 showToast("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","green");
}

// Export PDF
async function exportPDF(sectionId,fileName){
 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF("p","mm","a4");
 const element=document.getElementById(sectionId);
 await html2canvas(element).then(canvas=>{
   const img=canvas.toDataURL("image/png");
   pdf.addImage(img,"PNG",10,10,190,0);
 });
 pdf.save(fileName);
 showToast("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏•‡πâ‡∏ß","green");
}
document.getElementById("exportMyPDF").onclick=()=>exportPDF("my","my_report.pdf");
document.getElementById("exportOrgPDF").onclick=()=>exportPDF("org","organization_report.pdf");
document.getElementById("btnExportPDF").onclick=()=>exportPDF("overview","overview_report.pdf");

// Export Excel
function exportExcel(tableId,fileName){
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.table_to_sheet(document.getElementById(tableId));
 XLSX.utils.book_append_sheet(wb,ws,"Report");
 XLSX.writeFile(wb,fileName);
 showToast("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Excel ‡πÅ‡∏•‡πâ‡∏ß","green");
}
document.getElementById("exportExcel").onclick=()=>exportExcel("orgTable","organization_report.xlsx");
document.getElementById("btnExportExcel").onclick=()=>exportExcel("teamTable","team_report.xlsx");
</script>
</body>
</html>
