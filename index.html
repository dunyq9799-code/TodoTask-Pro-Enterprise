<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</title>

<!-- Font & Libraries -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
:root {
  --primary: #715aff;
  --primary-dark: #5d4de0;
  --bg-light: #f4f4f7;
  --bg-dark: #0d0d12;
  --card-light: #ffffff;
  --card-dark: #1a1a24;
  --text-light: #0d0d12;
  --text-dark: #f4f4f7;
  --warn: #f1c40f;
  --error: #e74c3c;
  --transition: all 0.3s ease;
}
* { box-sizing: border-box; }
body {
  font-family: 'Kanit', sans-serif;
  margin: 0;
  background: var(--bg-light);
  color: var(--text-light);
  transition: var(--transition);
}
body.dark { background: var(--bg-dark); color: var(--text-dark); }

header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 20px 32px;
  background: var(--card-light);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: var(--transition);
  position: relative; z-index: 5;
}
body.dark header { background: var(--card-dark); }
header h1 { color: var(--primary); font-size: 22px; margin: 0; display: flex; align-items: center; gap: 10px; }
.hamburger { font-size: 24px; cursor: pointer; background: none; border: none; color: var(--primary); }
.header-actions { display: flex; align-items: center; gap: 10px; position: relative; }
button {
  font-family: inherit; border: none; cursor: pointer;
  border-radius: 8px; padding: 8px 14px;
  font-size: 15px; transition: var(--transition);
}
.mode-toggle { background: var(--primary); color: white; }
.login-btn, .logout-btn { background: #6c63ff; color: white; }

/* ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF */
.report-btn {
  background: var(--primary); color: #fff;
  border-radius: 10px; padding: 8px 16px;
  transition: var(--transition);
}
.report-btn:hover { background: var(--primary-dark); }

/* Sidebar */
.sidebar {
  position: fixed; top: 0; left: -250px; width: 250px; height: 100%;
  background: var(--card-light); box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  padding: 20px; transition: var(--transition); z-index: 3;
}
body.dark .sidebar { background: var(--card-dark); }
.sidebar.active { left: 0; }
.sidebar h2 { color: var(--primary); }
.sidebar a { display: block; margin: 10px 0; color: inherit; text-decoration: none; }
.sidebar a:hover { color: var(--primary); }
.backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: none; z-index: 2; }
.backdrop.active { display: block; }

/* Layout */
main { padding: 24px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
.view-toggle { display: flex; gap: 10px; }
.view-toggle button { border: 1px solid var(--primary); background: transparent; color: var(--primary); border-radius: 10px; padding: 8px 14px; transition: var(--transition); }
.view-toggle button.active { background: var(--primary); color: white; }

.board, #calendar, #chartCard {
  width: 100%; max-width: 1200px;
  background: var(--card-light);
  border-radius: 12px; padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: var(--transition);
}
body.dark .board, body.dark #calendar, body.dark #chartCard { background: #111827; }

.task-card { border-radius: 12px; padding: 18px; margin: 10px; background: var(--card-light); box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: var(--transition); }
body.dark .task-card { background: var(--card-dark); }
.task-header { font-weight: 600; color: var(--primary); margin-bottom: 10px; }
.subtasks { list-style: none; padding: 0; margin: 0; }
.subtasks li { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.subtasks span.done { text-decoration: line-through; color: #999; }

/* Chart Header */
.chart-header { display: flex; justify-content: space-between; align-items: center; }
.chart-header h3 { color: var(--primary); margin: 0; }

.toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: #fff; padding: 12px 20px; border-radius: 6px; opacity: 0; transform: translateY(20px); transition: var(--transition); }
.toast.show { opacity: 1; transform: translateY(0); }

@media (max-width: 600px) {
  .board { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<header>
  <div class="left-header">
    <button class="hamburger" id="hamburger">‚ò∞</button>
    <h1>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h1>
  </div>
  <div class="header-actions">
    <button id="reportBtn" class="report-btn">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    <button id="modeToggle" class="mode-toggle">üåô</button>
  </div>
</header>

<aside class="sidebar" id="sidebar">
  <h2>‡πÄ‡∏°‡∏ô‡∏π</h2>
  <a href="#">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
  <a href="#">‚öôÔ∏è ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</a>
</aside>
<div class="backdrop" id="backdrop"></div>

<main id="mainContent">
  <div class="view-toggle">
    <button id="boardViewBtn" class="active">üìã ‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô</button>
    <button id="calendarViewBtn">üìÜ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</button>
  </div>

  <button id="addTaskBtn" class="report-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  <div class="board" id="board"></div>
  <div id="calendar" style="display:none;"></div>

  <div id="chartCard" style="display:none;">
    <div class="chart-header"><h3>üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3></div>
    <canvas id="weeklyChart" height="120"></canvas>
  </div>
</main>

<div id="toast" class="toast">‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc } 
  from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { jsPDF } from "jspdf";
import html2canvas from "html2canvas";

const firebaseConfig={apiKey:"AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",authDomain:"my-todo-list-9d2fa.firebaseapp.com",projectId:"my-todo-list-9d2fa",storageBucket:"my-todo-list-9d2fa.appspot.com",messagingSenderId:"631403892452",appId:"1:631403892452:web:66d382bf5f143fc05de6f1"};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

/* Dark Mode */
const modeToggle=document.getElementById("modeToggle");
document.body.classList.toggle("dark",localStorage.getItem("mode")==="dark");
modeToggle.textContent=document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
modeToggle.onclick=()=>{document.body.classList.toggle("dark");const m=document.body.classList.contains("dark")?"dark":"light";localStorage.setItem("mode",m);modeToggle.textContent=m==="dark"?"‚òÄÔ∏è":"üåô";};

/* Sidebar */
const sidebar=document.getElementById("sidebar"),backdrop=document.getElementById("backdrop");
document.getElementById("hamburger").onclick=()=>{sidebar.classList.add("active");backdrop.classList.add("active");};
backdrop.onclick=()=>{sidebar.classList.remove("active");backdrop.classList.remove("active");};

/* Firebase Sync */
let allTasks=[],calendar,chart;
onSnapshot(collection(db,"projects"),(snap)=>{allTasks=snap.docs.map(d=>({...d.data(),id:d.id}));renderBoard();renderCalendar();renderChart();});

/* Board */
const board=document.getElementById("board");
function renderBoard(){board.innerHTML="";allTasks.forEach(t=>{const card=document.createElement("div");card.className="task-card";card.innerHTML=`<div class='task-header'>${t.main}${t.done?" ‚úÖ":""}</div><small>‡πÄ‡∏î‡∏ó‡πÑ‡∏•‡∏ô‡πå: ${t.deadline||"-"}</small><br><small>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${t.assignee||"-"}</small>`;board.append(card);});}

/* Calendar */
const calendarEl=document.getElementById("calendar");
function renderCalendar(){if(!calendar){calendar=new FullCalendar.Calendar(calendarEl,{initialView:"dayGridMonth",height:"auto",editable:false,events:[]});calendar.render();}
calendar.removeAllEvents();calendar.addEventSource(allTasks.filter(t=>t.deadline).map(t=>({title:t.main,start:t.deadline,color:t.done?"#999":"#715aff"})));}

/* Weekly Chart */
function renderChart(){const ctx=document.getElementById("weeklyChart");const now=new Date();const days=["‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏Ø","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå","‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå"];
const start=new Date(now);start.setDate(now.getDate()-now.getDay()+1);
const done=new Array(7).fill(0),undone=new Array(7).fill(0);
allTasks.forEach(t=>{if(!t.deadline)return;const d=new Date(t.deadline);const diff=(d-start)/(1000*60*60*24);if(diff>=0&&diff<7){const i=Math.floor(diff);t.done?done[i]++:undone[i]++;}});
const txt=document.body.classList.contains("dark")?"#f4f4f7":"#0d0d12";
if(chart){chart.data.datasets[0].data=done;chart.data.datasets[1].data=undone;chart.update();return;}
chart=new Chart(ctx,{type:"bar",data:{labels:days,datasets:[{label:"‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß",backgroundColor:"#715aff",data:done},{label:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à",backgroundColor:"#cfcfcf",data:undone}]},options:{plugins:{legend:{labels:{color:txt}}},scales:{x:{ticks:{color:txt}},y:{ticks:{color:txt},beginAtZero:true}}}});}

/* View Toggle */
const boardViewBtn=document.getElementById("boardViewBtn"),calendarViewBtn=document.getElementById("calendarViewBtn"),chartCard=document.getElementById("chartCard");
boardViewBtn.onclick=()=>{calendarEl.style.display="none";chartCard.style.display="none";board.style.display="block";boardViewBtn.classList.add("active");calendarViewBtn.classList.remove("active");};
calendarViewBtn.onclick=()=>{board.style.display="none";calendarEl.style.display="block";chartCard.style.display="block";boardViewBtn.classList.remove("active");calendarViewBtn.classList.add("active");};

/* Toast */
const toast=document.getElementById("toast");function showToast(msg){toast.textContent=msg;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}

/* Export PDF */
document.getElementById("reportBtn").onclick=async()=>{
  showToast("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô...");
  const pdf=new jsPDF("p","mm","a4");
  const date=new Date().toISOString().split("T")[0];
  pdf.setFont("helvetica","bold");pdf.setTextColor(113,90,255);
  pdf.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (My Task Report)",15,15);
  pdf.setFontSize(11);pdf.setTextColor(50);pdf.text("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô: "+date,15,22);
  const content=document.getElementById("mainContent");
  const canvas=await html2canvas(content,{scale:1});
  const img=canvas.toDataURL("image/png");
  const imgProps=pdf.getImageProperties(img);
  const pdfWidth=210,pdfHeight=(imgProps.height*pdfWidth)/imgProps.width;
  pdf.addImage(img,"PNG",0,30,pdfWidth,pdfHeight);
  pdf.setFontSize(10);pdf.text("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô ‚Äì ‡∏û‡∏±‡∏ä ‡∏ô‡∏†‡∏≤ ‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï",15,290);
  pdf.save(`Task_Report_${date}.pdf`);
  showToast("‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î");
};
</script>
</body>
</html>
