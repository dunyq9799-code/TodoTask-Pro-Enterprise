<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Task Dashboard | User</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{box-sizing:border-box;font-family:"Kanit",sans-serif;transition:all .3s ease;}
:root{
  --violet:#715aff;
  --bg:#f4f4f7;
  --text:#0d0d12;
  --card:#fff;
}
body.dark{--bg:#0d0d12;--text:#f4f4f7;--card:#1a1a24;}
body{margin:0;background:var(--bg);color:var(--text);}
header{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--card);padding:10px 20px;box-shadow:0 0 8px rgba(0,0,0,.2);
  position:sticky;top:0;z-index:999;
}
header h1{color:var(--violet);margin:0;}
#toggleMode{background:none;border:none;font-size:22px;cursor:pointer;color:var(--text);}
#logoutBtn{background:var(--violet);color:#fff;border:none;padding:6px 12px;border-radius:8px;cursor:pointer;}
#sidebar{
  width:220px;position:fixed;top:60px;bottom:0;left:0;background:var(--card);
  box-shadow:2px 0 8px rgba(0,0,0,.15);overflow-y:auto;transition:width .3s;
}
#sidebar.collapsed{width:60px;}
#sidebar ul{list-style:none;padding:0;margin:0;}
#sidebar li{padding:15px;cursor:pointer;display:flex;align-items:center;}
#sidebar li:hover{background:rgba(113,90,255,0.1);}
#sidebar li.active{background:rgba(113,90,255,0.25);}
#sidebar span{margin-left:10px;}
#main{
  margin-left:220px;padding:20px;transition:margin-left .3s;
}
#sidebar.collapsed + #main{margin-left:60px;}
.card{
  background:var(--card);padding:20px;border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,.1);margin-bottom:20px;
}
.flex{display:flex;gap:15px;flex-wrap:wrap;}
.toast{
  position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:10px 16px;
  border-radius:8px;opacity:0;pointer-events:none;transition:opacity .3s;z-index:9999;
}
.toast.show{opacity:1;}
.fc{background:var(--card);border-radius:12px;padding:10px;}
@media(max-width:768px){
  #sidebar{position:fixed;top:60px;width:60px;}
  #main{margin-left:60px;}
}
button.primary{background:var(--violet);color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;}
input,textarea,select{width:100%;padding:8px;margin:5px 0;border:1px solid #ccc;border-radius:8px;}
input:focus,textarea:focus,select:focus{border-color:var(--violet);outline:none;}
</style>
</head>
<body>
<header>
  <h1>Task Dashboard</h1>
  <div>
    <button id="toggleMode">üåô</button>
    <span id="username" style="margin:0 10px;font-weight:600;"></span>
    <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</header>

<div id="sidebar">
  <ul>
    <li class="active" data-page="dashboard">üè†<span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></li>
    <li data-page="tasks">‚úÖ<span>‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></li>
    <li data-page="calendar">üìÖ<span>‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</span></li>
    <li data-page="reports">üßæ<span>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></li>
    <li data-page="settings">‚öôÔ∏è<span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></li>
    <li id="logoutSide">üö™<span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></li>
  </ul>
</div>

<main id="main">
  <!-- Dashboard Overview -->
  <section id="dashboard" class="page">
    <div class="flex">
      <div class="card" style="flex:1;">
        <h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
        <p id="totalTasks">0 ‡∏á‡∏≤‡∏ô</p>
      </div>
      <div class="card" style="flex:1;">
        <h3>‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</h3>
        <p id="completedTasks">0 ‡∏á‡∏≤‡∏ô</p>
      </div>
      <div class="card" style="flex:1;">
        <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
        <p id="inProgressTasks">0 ‡∏á‡∏≤‡∏ô</p>
      </div>
      <div class="card" style="flex:1;">
        <h3>‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h3>
        <p id="overdueTasks">0 ‡∏á‡∏≤‡∏ô</p>
      </div>
    </div>
    <div class="flex">
      <div class="card" style="flex:1;min-width:300px;"><canvas id="pieChart"></canvas></div>
      <div class="card" style="flex:1;min-width:300px;"><canvas id="barChart"></canvas></div>
    </div>
  </section>

  <!-- My Tasks -->
  <section id="tasks" class="page" style="display:none;">
    <div class="card">
      <h2>‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
      <button id="addTaskBtn" class="primary">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
      <div id="taskList"></div>
    </div>
  </section>

  <!-- Calendar -->
  <section id="calendar" class="page" style="display:none;">
    <div class="card"><div id="calendarView"></div></div>
  </section>

  <!-- Reports -->
  <section id="reports" class="page" style="display:none;">
    <div class="card">
      <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
      <div id="reportArea"></div>
      <button id="exportPDF" class="primary">üìÑ Export PDF</button>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="page" style="display:none;">
    <div class="card">
      <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
      <label>‡∏ä‡∏∑‡πà‡∏≠</label>
      <input id="setName">
      <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input id="setEmail" disabled>
      <button id="updateName" class="primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
      <hr>
      <button id="clearCache" class="primary">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</button>
      <button id="deleteAccount" style="background:crimson;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">üóë ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
    </div>
  </section>
</main>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, onAuthStateChanged, signOut, deleteUser, updateProfile 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
  authDomain:"my-todo-list-9d2fa.firebaseapp.com",
  projectId:"my-todo-list-9d2fa",
  storageBucket:"my-todo-list-9d2fa.appspot.com",
  messagingSenderId:"631403892452",
  appId:"1:631403892452:web:66d382bf5f143fc05de6f1"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const toast=document.getElementById("toast");
function showToast(msg,color="#333"){
  toast.textContent=msg;toast.style.background=color;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

// Theme
const body=document.body,toggle=document.getElementById("toggleMode");
if(localStorage.getItem("theme")==="dark"){body.classList.add("dark");toggle.textContent="‚òÄÔ∏è";}
toggle.onclick=()=>{body.classList.toggle("dark");toggle.textContent=body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
localStorage.setItem("theme",body.classList.contains("dark")?"dark":"light");};

// Navigation
document.querySelectorAll("#sidebar li[data-page]").forEach(li=>{
  li.onclick=()=>{
    document.querySelectorAll("#sidebar li").forEach(x=>x.classList.remove("active"));
    li.classList.add("active");
    document.querySelectorAll(".page").forEach(p=>p.style.display="none");
    document.getElementById(li.dataset.page).style.display="block";
  };
});
document.getElementById("logoutBtn").onclick=()=>signOut(auth);
document.getElementById("logoutSide").onclick=()=>signOut(auth);

// Auth check
onAuthStateChanged(auth,async user=>{
  if(!user||!user.emailVerified){window.location.href="login.html";return;}
  const uRef=doc(db,"users",user.uid);const snap=await getDoc(uRef);
  if(!snap.exists()||snap.data().role!=="user"){window.location.href="admin.html";return;}
  document.getElementById("username").textContent=snap.data().name||"User";
  loadTasks(user.uid);
});

// Load Tasks
async function loadTasks(uid){
  const q=query(collection(db,"tasks"),where("ownerUid","==",uid));
  const qs=await getDocs(q);
  const tasks=qs.docs.map(d=>({id:d.id,...d.data()}));
  updateDashboard(tasks);
  renderTasks(tasks);
  renderCalendar(tasks);
  renderReport(tasks);
}

// Dashboard summary
function updateDashboard(tasks){
  const total=tasks.length;
  const done=tasks.filter(t=>t.status==="done").length;
  const doing=tasks.filter(t=>t.status==="doing").length;
  const overdue=tasks.filter(t=>new Date(t.deadline)<new Date()&&t.status!=="done").length;
  document.getElementById("totalTasks").textContent=total+" ‡∏á‡∏≤‡∏ô";
  document.getElementById("completedTasks").textContent=done+" ‡∏á‡∏≤‡∏ô";
  document.getElementById("inProgressTasks").textContent=doing+" ‡∏á‡∏≤‡∏ô";
  document.getElementById("overdueTasks").textContent=overdue+" ‡∏á‡∏≤‡∏ô";
  new Chart(document.getElementById("pieChart"),{type:"pie",
    data:{labels:["‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥","‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î"],
    datasets:[{data:[done,doing,overdue],backgroundColor:["#4CAF50","#FFC107","#F44336"]}]},
    options:{plugins:{legend:{position:"bottom"}}}});
  new Chart(document.getElementById("barChart"),{type:"bar",
    data:{labels:["‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î","‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß","‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥","‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î"],
    datasets:[{data:[total,done,doing,overdue],backgroundColor:"#715aff"}]},
    options:{plugins:{legend:{display:false}}}});
}

// Render tasks list
function renderTasks(tasks){
  const container=document.getElementById("taskList");
  container.innerHTML="";
  tasks.forEach(t=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`<h3>${t.title}</h3><p>${t.detail||""}</p>
    <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${t.deadline||"-"} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${t.status||"-"}</p>
    <button onclick="deleteTask('${t.id}')" style="background:crimson;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">üóë ‡∏•‡∏ö</button>`;
    container.appendChild(div);
  });
}
window.deleteTask=async(id)=>{
  await deleteDoc(doc(db,"tasks",id));
  showToast("üóë ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß","crimson");
  loadTasks(auth.currentUser.uid);
};

// Add task
document.getElementById("addTaskBtn").onclick=async()=>{
  const title=prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏á‡∏≤‡∏ô:");
  if(!title)return;
  await addDoc(collection(db,"tasks"),{
    ownerUid:auth.currentUser.uid,title,detail:"",status:"doing",deadline:null,createdAt:serverTimestamp()
  });
  showToast("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß","green");
  loadTasks(auth.currentUser.uid);
};

// Calendar
function renderCalendar(tasks){
  const calEl=document.getElementById("calendarView");
  calEl.innerHTML="";
  const calendar=new FullCalendar.Calendar(calEl,{
    initialView:"dayGridMonth",
    events:tasks.filter(t=>t.deadline).map(t=>({title:t.title,date:t.deadline})),
    eventClick:info=>alert(`üìå ${info.event.title}`)
  });
  calendar.render();
}

// Report
function renderReport(tasks){
  const area=document.getElementById("reportArea");
  const done=tasks.filter(t=>t.status==="done").length;
  const total=tasks.length;
  const percent=total?Math.round((done/total)*100):0;
  area.innerHTML=`<p>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}</p><p>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: ${done}</p><h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${percent}%</h3>`;
}
document.getElementById("exportPDF").onclick=()=>{
  html2canvas(document.getElementById("reportArea")).then(canvas=>{
    const img=canvas.toDataURL("image/png");
    const pdf=new jspdf.jsPDF();
    pdf.addImage(img,"PNG",10,10,180,0);
    pdf.save("my-report.pdf");
  });
};

// Settings
document.getElementById("updateName").onclick=async()=>{
  const name=document.getElementById("setName").value.trim();
  if(!name){showToast("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠","orange");return;}
  const uRef=doc(db,"users",auth.currentUser.uid);
  await updateDoc(uRef,{name});
  await updateProfile(auth.currentUser,{displayName:name});
  showToast("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","green");
};
document.getElementById("clearCache").onclick=()=>{localStorage.clear();showToast("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß","green");};
document.getElementById("deleteAccount").onclick=async()=>{
  if(confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ?")){
    await deleteUser(auth.currentUser);
    showToast("üóë ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß","crimson");
    window.location.href="login.html";
  }
};
</script>
</body>
</html>
