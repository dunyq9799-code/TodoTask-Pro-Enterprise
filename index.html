<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô - ‡∏û‡∏±‡∏ä ‡∏ô‡∏†‡∏≤ ‡∏°‡∏≤‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ï</title>

<!-- Fonts & Libraries -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css" rel="stylesheet">

<style>
:root {
  --primary: #715aff;
  --primary-dark: #5d4de0;
  --bg-light: #f4f4f7;
  --bg-dark: #0d0d12;
  --card-light: #ffffff;
  --card-dark: #1a1a24;
  --text-light: #0d0d12;
  --text-dark: #f4f4f7;
  --error: #e74c3c;
  --warn: #f1c40f;
  --success: #27ae60;
  --transition: all 0.3s ease;
}
*{box-sizing:border-box;margin:0;padding:0;}
body {
  font-family:'Kanit',sans-serif;
  background:var(--bg-light);
  color:var(--text-light);
  transition:var(--transition);
  overflow-x:hidden;
}
body.dark{background:var(--bg-dark);color:var(--text-dark);}

/* Header */
header{
  display:flex;justify-content:space-between;align-items:center;
  padding:16px 32px;background:var(--card-light);
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  position:sticky;top:0;z-index:1000;transition:var(--transition);
}
body.dark header{background:var(--card-dark);}
header h1{color:var(--primary);font-size:22px;}
button{
  font-family:inherit;border:none;cursor:pointer;
  border-radius:8px;padding:8px 14px;font-size:15px;
  transition:var(--transition);
}
.report-btn{background:var(--primary);color:#fff;}
.report-btn:hover{background:var(--primary-dark);}
.mode-toggle{background:var(--primary);color:#fff;}
.hamburger{background:var(--primary);color:#fff;font-size:20px;}
header .right-buttons{display:flex;gap:10px;align-items:center;}

/* Sidebar */
.sidebar{
  position:fixed;top:0;left:-260px;width:240px;height:100%;
  background:var(--card-light);box-shadow:2px 0 10px rgba(0,0,0,0.2);
  padding:20px;transition:var(--transition);z-index:10;
}
body.dark .sidebar{background:var(--card-dark);}
.sidebar.active{left:0;}
.sidebar h2{color:var(--primary);margin-bottom:10px;}
.sidebar a{display:block;margin:8px 0;color:inherit;text-decoration:none;}
.sidebar a:hover{color:var(--primary);}
.backdrop{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);display:none;z-index:5;
}
.backdrop.active{display:block;}

/* Notification Icon */
#notifIcon{
  position:relative;font-size:22px;cursor:pointer;
}
#notifIcon::after{
  content:"";position:absolute;top:0;right:0;width:8px;height:8px;
  background:#e74c3c;border-radius:50%;display:none;
}
#notifIcon.active::after{display:block;}
#notifBox{
  position:absolute;top:60px;right:20px;width:300px;
  background:var(--card-light);border-radius:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.2);
  display:none;flex-direction:column;max-height:400px;overflow-y:auto;
  z-index:2000;padding:10px;
}
body.dark #notifBox{background:var(--card-dark);}
#notifBox.active{display:flex;}
.notif-item{
  border-bottom:1px solid rgba(0,0,0,0.1);
  padding:8px 6px;font-size:14px;
}
.notif-item:last-child{border-bottom:none;}
.notif-item.unread{background:rgba(113,90,255,0.1);}
.notif-item small{display:block;color:gray;font-size:12px;}
.notif-item button{
  margin-top:4px;background:var(--primary);color:#fff;
  padding:3px 8px;font-size:12px;border-radius:6px;
}

/* Main */
main{padding:24px;display:flex;flex-direction:column;align-items:center;gap:20px;}
.view-toggle{display:flex;gap:10px;}
.view-toggle button{
  border:1px solid var(--primary);background:transparent;
  color:var(--primary);border-radius:10px;padding:8px 14px;
}
.view-toggle button.active{background:var(--primary);color:white;}

.board,#calendar,#chartCard{
  width:100%;max-width:1200px;background:var(--card-light);
  border-radius:12px;padding:20px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
  transition:var(--transition);
}
body.dark .board,body.dark #calendar,body.dark #chartCard{background:#111827;}

/* Toast */
.toast{
  position:fixed;bottom:24px;right:24px;background:#333;color:#fff;
  padding:12px 20px;border-radius:6px;opacity:0;
  transform:translateY(20px);transition:var(--transition);z-index:2500;
}
.toast.show{opacity:1;transform:translateY(0);}
.toast.error{background:var(--error);}
.toast.success{background:var(--success);}
.toast.offline{background:var(--warn);color:#111;}

/* Chat Button */
#chatBtn{
  position:fixed;bottom:20px;right:20px;
  background:var(--primary);color:#fff;
  border-radius:50%;width:55px;height:55px;
  font-size:24px;display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  cursor:pointer;z-index:1600;transition:var(--transition);
}
#chatBtn:hover{transform:scale(1.05);}

/* Chat Popup */
#chatBox{
  position:fixed;bottom:-100%;right:20px;width:320px;height:420px;
  background:var(--card-light);border-radius:12px 12px 0 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.3);
  display:flex;flex-direction:column;overflow:hidden;
  transition:var(--transition);z-index:2000;
}
body.dark #chatBox{background:var(--card-dark);}
#chatBox.active{bottom:80px;}
.chat-header{
  background:var(--primary);color:#fff;padding:10px;
  display:flex;justify-content:space-between;align-items:center;
}
.chat-messages{
  flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;
}
.chat-msg{
  max-width:80%;padding:8px 12px;border-radius:12px;font-size:14px;
}
.chat-msg.me{align-self:flex-end;background:var(--primary);color:#fff;}
.chat-msg.other{align-self:flex-start;background:#e0e0e0;color:#111;}
body.dark .chat-msg.other{background:#333;color:#eee;}
.chat-input{display:flex;border-top:1px solid #ccc;}
.chat-input input{
  flex:1;padding:10px;border:none;outline:none;font-family:'Kanit';
}
.chat-input button{
  background:var(--primary);color:#fff;padding:10px 16px;
  border-radius:0 0 12px 0;
}
.chat-input button:hover{background:var(--primary-dark);}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <button id="hamburger" class="hamburger">‚ò∞</button>
    <h1>üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h1>
  </div>
  <div class="right-buttons">
    <span id="notifIcon">üîî</span>
    <button id="loginBtn" class="report-btn">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button id="logoutBtn" class="report-btn" style="display:none;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    <button id="reportBtn" class="report-btn" style="display:none;">üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
    <button id="logBtn" class="report-btn" style="display:none;">üß© ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Log</button>
    <button id="modeToggle" class="mode-toggle">üåô</button>
  </div>
</header>

<!-- Notification Box -->
<div id="notifBox"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <h2>‡πÄ‡∏°‡∏ô‡∏π</h2>
  <a href="#">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
  <a href="#">‚öôÔ∏è ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</a>
</aside>
<div class="backdrop" id="backdrop"></div>

<main id="mainContent">
  <div class="view-toggle">
    <button id="boardViewBtn" class="active">üìã ‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏á‡∏≤‡∏ô</button>
    <button id="calendarViewBtn">üìÜ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô</button>
  </div>

  <button id="addTaskBtn" class="report-btn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
  <div class="board" id="board"></div>
  <div id="calendar" style="display:none;"></div>

  <div id="chartCard" style="display:none;">
    <h3>üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
    <canvas id="weeklyChart" height="120"></canvas>
  </div>
</main>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Chat Button + Box -->
<div id="chatBtn" style="display:none;">üí¨</div>
<div id="chatBox">
  <div class="chat-header">
    <span>üí¨ ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏µ‡∏°</span>
    <button id="chatClose" style="background:none;color:#fff;font-size:18px;">‚úñ</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
    <button id="chatSend">‡∏™‡πà‡∏á</button>
  </div>
</div>

<!-- JavaScript ‡∏à‡∏∞‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 -->
  <script type="module">
// ============================
// üîß 1. Initialize Firebase
// ============================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, onSnapshot,
  query, where, updateDoc, doc, serverTimestamp, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
  authDomain: "my-todo-list-9d2fa.firebaseapp.com",
  projectId: "my-todo-list-9d2fa",
  storageBucket: "my-todo-list-9d2fa.appspot.com",
  messagingSenderId: "631403892452",
  appId: "1:631403892452:web:66d382bf5f143fc05de6f1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ============================
// üåô 2. Theme Mode Toggle
// ============================
const body = document.body;
const modeToggle = document.getElementById("modeToggle");
if(localStorage.getItem("mode")==="dark"){body.classList.add("dark");modeToggle.textContent="‚òÄÔ∏è";}
modeToggle.onclick = ()=> {
  body.classList.toggle("dark");
  const dark = body.classList.contains("dark");
  localStorage.setItem("mode", dark ? "dark" : "light");
  modeToggle.textContent = dark ? "‚òÄÔ∏è" : "üåô";
};

// ============================
// üìã 3. Auth System (Login/Logout)
// ============================
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const chatBtn = document.getElementById("chatBtn");
let currentUser = null;

loginBtn.onclick = async ()=>{
  const email = prompt("‡∏≠‡∏µ‡πÄ‡∏°‡∏•:");
  const pass = prompt("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:");
  if(!email||!pass) return;
  try{
    await signInWithEmailAndPassword(auth,email,pass);
  }catch{
    if(confirm("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏´‡∏°?")){
      const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:");
      await createUserWithEmailAndPassword(auth,email,pass);
      await addDoc(collection(db,"users"),{email,name,role:"user",createdAt:serverTimestamp()});
    }
  }
};
logoutBtn.onclick = ()=> signOut(auth);

onAuthStateChanged(auth, user=>{
  if(user){
    currentUser = user;
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    chatBtn.style.display="flex";
    initNotifications();
    initChat();
  } else {
    currentUser = null;
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    chatBtn.style.display="none";
    document.getElementById("notifBox").innerHTML="";
  }
});

// ============================
// üîî 4. Cross-User Notifications
// ============================
const notifIcon = document.getElementById("notifIcon");
const notifBox = document.getElementById("notifBox");

notifIcon.onclick = ()=> notifBox.classList.toggle("active");

function showToast(msg,type="success"){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=`toast show ${type}`;
  setTimeout(()=>t.className="toast",3000);
}

// listen & render notifications
function initNotifications(){
  const q = query(collection(db,"notifications"), where("to","==",currentUser.uid), orderBy("timestamp","desc"));
  onSnapshot(q, snap=>{
    notifBox.innerHTML="";
    let unread=false;
    snap.forEach(docu=>{
      const n=docu.data();
      const div=document.createElement("div");
      div.className=`notif-item ${n.read?"":"unread"}`;
      div.innerHTML=`
        <strong>${n.message}</strong>
        <small>${new Date(n.timestamp?.toDate?.()??Date.now()).toLocaleString()}</small>
        ${!n.read?'<button>‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>':""}
      `;
      const btn=div.querySelector("button");
      if(btn) btn.onclick=async()=>{
        await updateDoc(doc(db,"notifications",docu.id),{read:true});
        showToast("‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
      };
      notifBox.appendChild(div);
      if(!n.read) unread=true;
    });
    notifIcon.classList.toggle("active",unread);
  });
}

// notify function (for admin assign / user done)
async function sendNotification(to,from,type,msg,taskId){
  try{
    await addDoc(collection(db,"notifications"),{
      to,from,type,message:msg,taskId,timestamp:serverTimestamp(),read:false
    });
  }catch(e){console.error(e);}
}

// ============================
// üí¨ 5. Team Chat Realtime
// ============================
const chatBox=document.getElementById("chatBox");
const chatClose=document.getElementById("chatClose");
const chatInput=document.getElementById("chatInput");
const chatSend=document.getElementById("chatSend");
const chatMessages=document.getElementById("chatMessages");

chatBtn.onclick=()=> chatBox.classList.add("active");
chatClose.onclick=()=> chatBox.classList.remove("active");

function renderMessage(data){
  const div=document.createElement("div");
  div.className=`chat-msg ${data.from.uid===currentUser.uid?'me':'other'}`;
  div.textContent=`${data.from.name??'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}: ${data.message}`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

function initChat(){
  const q=query(collection(db,"teamChats"),orderBy("timestamp"));
  onSnapshot(q,snap=>{
    chatMessages.innerHTML="";
    snap.forEach(d=>renderMessage(d.data()));
  });
}

chatSend.onclick=sendChat;
chatInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendChat();});

async function sendChat(){
  const msg=chatInput.value.trim();
  if(!msg||!currentUser)return;
  try{
    await addDoc(collection(db,"teamChats"),{
      from:{uid:currentUser.uid,name:currentUser.email.split("@")[0]},
      message:msg,team:"global",timestamp:serverTimestamp()
    });
    chatInput.value="";
  }catch(e){showToast("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","error");}
}

// ============================
// ‚úÖ Ready Message
// ============================
console.log("%c‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß","color:#715aff;font-weight:bold;");
</script>
</body>
</html>
