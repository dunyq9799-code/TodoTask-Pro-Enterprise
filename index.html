<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TodoTask Pro Enterprise</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: rgba(25, 0, 60, 0.6);
      --glass: rgba(255,255,255,0.12);
      --blur: blur(15px);
      --accent: #b794f6;
      --accent-dark: #7f56da;
      --text: #fff;
    }

    body {
      font-family: 'Sarabun', sans-serif;
      background: radial-gradient(circle at top left, #2a1b4a, #0b0615);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      backdrop-filter: var(--blur);
      background: var(--glass);
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    h1 { font-weight: 600; letter-spacing: 1px; }

    .menu-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
    }

    .menu {
      position: absolute;
      top: 65px;
      right: 25px;
      background: var(--glass);
      backdrop-filter: var(--blur);
      border-radius: 10px;
      padding: 10px;
      display: none;
      flex-direction: column;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }

    .menu a {
      color: #fff;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 8px;
      transition: 0.3s;
    }
    .menu a:hover { background: rgba(255,255,255,0.1); }

    .board-container {
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .board {
      background: var(--glass);
      backdrop-filter: var(--blur);
      border-radius: 14px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: 0.3s;
    }

    .board h2 {
      margin-top: 0;
      font-size: 18px;
      color: var(--accent);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .subtask {
      margin: 8px 0;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: 0.2s;
    }
    .subtask:hover { background: rgba(255,255,255,0.1); }

    .completed span { text-decoration: line-through; opacity: 0.7; }

    .add-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: none;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 36px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: 0.3s;
    }
    .add-btn:hover { transform: scale(1.1); }

    .popup {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .popup-content {
      background: var(--glass);
      backdrop-filter: var(--blur);
      border-radius: 14px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin-bottom: 12px;
      font-family: inherit;
      font-size: 14px;
    }

    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      background: var(--accent-dark);
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: var(--accent); }
  </style>
</head>

<body>
  <header>
    <h1>TodoTask Pro Enterprise</h1>
    <div>
      <button class="menu-btn" id="menuToggle">‚ò∞</button>
      <div class="menu" id="menu">
        <a href="#">üìã ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a>
        <a href="#">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
        <a href="#">üßë‚Äçüíº ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</a>
      </div>
    </div>
  </header>

  <main class="board-container" id="boardContainer"></main>
  <button class="add-btn" id="addTask">Ôºã</button>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <h3 id="popupTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
      <input id="mainTask" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà...">
      <textarea id="subTasks" rows="4" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏¢‡πà‡∏≠‡∏¢ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)"></textarea>
      <input type="date" id="deadline">
      <div style="text-align:right;">
        <button id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
      authDomain: "my-todo-list-9d2fa.firebaseapp.com",
      projectId: "my-todo-list-9d2fa",
      storageBucket: "my-todo-list-9d2fa.appspot.com",
      messagingSenderId: "631403892452",
      appId: "1:631403892452:web:66d382bf5f143fc05de6f1"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const boardContainer = document.getElementById("boardContainer");
    const popup = document.getElementById("popup");
    const saveBtn = document.getElementById("saveBtn");
    const addBtn = document.getElementById("addTask");
    const menuToggle = document.getElementById("menuToggle");
    const menu = document.getElementById("menu");

    let editingId = null;
    let role = "admin"; // ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå admin ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ

    // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
    menuToggle.onclick = () => {
      menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    };
    window.onclick = (e) => {
      if (!menu.contains(e.target) && e.target !== menuToggle) menu.style.display = "none";
    };

    // ‡πÄ‡∏õ‡∏¥‡∏î popup
    addBtn.onclick = () => {
      popup.style.display = "flex";
      document.getElementById("mainTask").value = "";
      document.getElementById("subTasks").value = "";
      document.getElementById("deadline").value = "";
      editingId = null;
    };

    // ‡∏õ‡∏¥‡∏î popup ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å
    popup.onclick = (e) => {
      if (e.target === popup) {
        if (!document.getElementById("mainTask").value.trim()) popup.style.display = "none";
      }
    };

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
    saveBtn.onclick = async () => {
      const mainTask = document.getElementById("mainTask").value.trim();
      const subTasks = document.getElementById("subTasks").value.trim().split("\n").filter(s => s);
      const deadline = document.getElementById("deadline").value;
      if (!mainTask) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô");

      if (editingId) {
        await updateDoc(doc(db, "tasks", editingId), { mainTask, subTasks, done: [], deadline });
      } else {
        await addDoc(collection(db, "tasks"), { mainTask, subTasks, done: [], deadline });
      }
      popup.style.display = "none";
    };

    // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    onSnapshot(collection(db, "tasks"), snapshot => {
      boardContainer.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const board = document.createElement("div");
        board.className = "board" + (data.done.length === data.subTasks.length ? " completed" : "");
        const percent = data.subTasks.length ? Math.round((data.done.length / data.subTasks.length) * 100) : 0;
        board.innerHTML = `
          <h2>${data.mainTask} 
            <span>${percent}% ${data.deadline ? `üóì ${data.deadline}` : ""}</span>
          </h2>
          ${data.subTasks.map((s, i) => `
            <div class="subtask ${data.done.includes(i) ? "completed" : ""}" data-id="${docSnap.id}" data-index="${i}">
              <span>${s}</span>
              <input type="checkbox" ${data.done.includes(i) ? "checked" : ""}>
            </div>`).join("")}
          ${role === "admin" ? `<button onclick="editTask('${docSnap.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>` : ""}
        `;
        boardContainer.appendChild(board);
      });

      // ‡∏Å‡∏î‡∏ï‡∏¥‡πä‡∏Å‡∏¢‡πà‡∏≠‡∏¢
      document.querySelectorAll(".subtask input").forEach(input => {
        input.onchange = async (e) => {
          const parent = e.target.closest(".subtask");
          const id = parent.dataset.id;
          const index = parseInt(parent.dataset.index);
          const docRef = doc(db, "tasks", id);
          const taskSnap = snapshot.docs.find(d => d.id === id);
          const task = taskSnap.data();
          let done = task.done || [];
          if (e.target.checked) done.push(index);
          else done = done.filter(i => i !== index);

          // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏¥‡πä‡∏Å‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏™‡∏£‡πá‡∏à
          if (done.length === task.subTasks.length) console.log("üéâ ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß");
          await updateDoc(docRef, { done });
        };
      });

      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏≤‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      if (role === "admin") {
        new Sortable(boardContainer, { animation: 150 });
      }
    });

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    window.editTask = async (id) => {
      const docs = await getDocs(collection(db, "tasks"));
      const data = docs.docs.find(d => d.id === id).data();
      popup.style.display = "flex";
      document.getElementById("mainTask").value = data.mainTask;
      document.getElementById("subTasks").value = data.subTasks.join("\n");
      document.getElementById("deadline").value = data.deadline || "";
      editingId = id;
    };
  </script>
</body>
</html>
