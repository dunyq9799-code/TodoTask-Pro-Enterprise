<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üöÄ TodoTask Pro - Cosmic Enterprise Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --accent: #e0c097;
      --bg-light: #faf8f5;
      --bg-dark: radial-gradient(circle at center, #0a0f24, #000);
      --text-dark: #222;
      --text-light: #f4f4f4;
      --card-light: rgba(255,255,255,0.8);
      --card-dark: rgba(30,35,50,0.9);
    }
    body {
      font-family: 'Sarabun', sans-serif;
      margin: 0; padding: 0;
      background: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.6s, color 0.6s;
    }
    body.dark { background: var(--bg-dark); color: var(--text-light); }
    header {
      text-align: center;
      padding: 20px;
      font-size: 1.8em;
      color: var(--accent);
      font-weight: 600;
      text-shadow: 0 0 10px rgba(224,192,151,0.4);
    }
    .container { max-width: 1000px; margin: auto; padding: 20px; display: flex; flex-direction: column; gap: 25px; }
    .card {
      background: var(--card-light);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: 0.5s;
    }
    body.dark .card { background: var(--card-dark); box-shadow: 0 4px 20px rgba(255,255,255,0.05); }
    .theme-toggle {
      position: fixed;
      top: 15px; right: 20px;
      background: var(--accent);
      border: none;
      width: 50px; height: 50px;
      border-radius: 50%;
      color: #fff;
      font-size: 22px;
      cursor: pointer;
      z-index: 100;
      transition: 0.3s;
    }
    .theme-toggle:hover { transform: scale(1.1); }

    /* ü™ê Cosmic Meter */
    .meter {
      position: relative;
      width: 200px; height: 200px;
      margin: 20px auto;
    }
    .meter svg { transform: rotate(-90deg); width: 200px; height: 200px; }
    .meter circle { fill: none; stroke-width: 10; stroke-linecap: round; }
    .meter-bg { stroke: #ccc; }
    .meter-bar { stroke: var(--accent); stroke-dasharray: 628; stroke-dashoffset: 628; transition: 1s; filter: drop-shadow(0 0 6px rgba(224,192,151,0.6)); }
    .meter-text {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px; font-weight: 700;
      color: var(--accent); text-shadow: 0 0 6px rgba(224,192,151,0.4);
    }

    /* üéñÔ∏è Ranking Board */
    .ranking { display: flex; flex-direction: column; gap: 10px; }
    .rank-item {
      display: flex; justify-content: space-between;
      padding: 8px 12px; border-radius: 10px;
      background: rgba(224,192,151,0.1);
      border: 1px solid rgba(224,192,151,0.3);
    }
    .rank-item span { font-weight: 500; }
    .rank-item:nth-child(1) { background: rgba(224,192,151,0.3); border-color: gold; }

    /* üîî Notification */
    .notification {
      position: fixed;
      top: 20px; left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #fff; padding: 12px 20px;
      border-radius: 10px;
      font-size: 15px;
      opacity: 0; animation: fade 4s forwards;
    }
    @keyframes fade {
      0% { opacity: 0; transform: translate(-50%, -10px); }
      10% { opacity: 1; transform: translate(-50%, 0); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, -10px); }
    }

    /* üìà ‡∏Å‡∏£‡∏≤‡∏ü */
    canvas { max-width: 100%; }

    @media (max-width: 768px) {
      header { font-size: 1.4em; }
      .container { padding: 10px; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
  <header>üöÄ TodoTask Pro - Cosmic Enterprise Dashboard</header>
  <div class="container">
    <!-- ü™ê Meter -->
    <div class="card">
      <h2>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ç‡∏≠‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</h2>
      <div class="meter">
        <svg><circle class="meter-bg" cx="100" cy="100" r="95"></circle><circle class="meter-bar" cx="100" cy="100" r="95"></circle></svg>
        <div class="meter-text" id="meterPercent">0%</div>
      </div>
      <p id="summaryText" style="text-align:center;color:var(--accent)">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- üç© Pie Chart -->
    <div class="card">
      <h2>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</h2>
      <canvas id="pieChart"></canvas>
    </div>

    <!-- üìà Bar Chart -->
    <div class="card">
      <h2>‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
      <canvas id="barChart"></canvas>
    </div>

    <!-- üß† AI Assistant -->
    <div class="card" id="aiBox">
      <h2>ü§ñ ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (AI Insight)</h2>
      <p id="aiMessage">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•...</p>
    </div>

    <!-- üéñÔ∏è Ranking -->
    <div class="card">
      <h2>üèÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡∏°</h2>
      <div class="ranking" id="rankingList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } 
      from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
      authDomain: "my-todo-list-9d2fa.firebaseapp.com",
      projectId: "my-todo-list-9d2fa",
      storageBucket: "my-todo-list-9d2fa.appspot.com",
      messagingSenderId: "631403892452",
      appId: "1:631403892452:web:66d382bf5f143fc05de6f1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üåó ‡∏ò‡∏µ‡∏°
    function toggleTheme() {
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      document.querySelector(".theme-toggle").textContent = isDark ? "üåô" : "‚òÄÔ∏è";
    }
    if (localStorage.getItem("theme") === "dark") {
      document.body.classList.add("dark");
      document.querySelector(".theme-toggle").textContent = "üåô";
    }

    let pieChart, barChart;
    onSnapshot(collection(db, "tasks"), (snapshot) => {
      const tasks = snapshot.docs.map(d => d.data());
      const total = tasks.length;
      const done = tasks.filter(t => t.completed).length;
      const percent = total ? Math.round((done / total) * 100) : 0;
      updateMeter(percent, done, total);
      updateAI(tasks, percent);
      showNotification("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡πÅ‡∏•‡πâ‡∏ß üöÄ");

      const categories = tasks.reduce((acc, t) => {
        acc[t.category] = (acc[t.category] || 0) + 1;
        return acc;
      }, {});
      updatePie(categories);
      updateBar(tasks);
      updateRanking(tasks);
    });

    function updateMeter(percent, done, total) {
      const bar = document.querySelector(".meter-bar");
      const offset = 628 - (628 * percent) / 100;
      bar.style.strokeDashoffset = offset;
      document.getElementById("meterPercent").textContent = percent + "%";
      document.getElementById("summaryText").textContent = `‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ${done}/${total} ‡∏á‡∏≤‡∏ô`;
    }

    function updatePie(data) {
      const ctx = document.getElementById("pieChart");
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(ctx, {
        type: "pie",
        data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: ["#e0c097","#bfa58a","#9b8065"] }] },
        options: { plugins: { legend: { position: "bottom" } } }
      });
    }

    function updateBar(tasks) {
      const today = new Date();
      const days = [...Array(7)].map((_, i) => {
        const d = new Date(today);
        d.setDate(today.getDate() - (6 - i));
        return d.toISOString().slice(0, 10);
      });
      const data = days.map(day =>
        tasks.filter(t => t.completed && (t.createdAt+"").includes(day)).length
      );
      const ctx = document.getElementById("barChart");
      if (barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: "bar",
        data: { labels: ["‡∏à","‡∏≠","‡∏û","‡∏û‡∏§","‡∏®","‡∏™","‡∏≠‡∏≤"], datasets: [{ data, backgroundColor: "rgba(224,192,151,0.8)" }] },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function updateAI(tasks, percent) {
      const msg = document.getElementById("aiMessage");
      const trend = percent > 70 ? "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å ‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏∏‡πà‡∏á‡∏ó‡∏∞‡∏•‡∏∏‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• üåü" :
                   percent > 40 ? "‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ üí´" :
                   "‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏î‡∏•‡∏á üò¢ ‡∏•‡∏≠‡∏á‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏ó‡∏µ‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏´‡∏ô‡πà‡∏≠‡∏¢!";
      msg.textContent = trend;
    }

    function updateRanking(tasks) {
      const rankBox = document.getElementById("rankingList");
      const map = {};
      tasks.forEach(t => {
        const name = t.owner || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
        map[name] = (map[name] || 0) + (t.completed ? 1 : 0);
      });
      const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]);
      rankBox.innerHTML = sorted.map(([n,c],i)=>`<div class="rank-item"><span>${i+1}. ${n}</span><span>${c} ‡∏á‡∏≤‡∏ô</span></div>`).join("");
    }

    function showNotification(text) {
      const note = document.createElement("div");
      note.className = "notification";
      note.textContent = text;
      document.body.appendChild(note);
      setTimeout(()=>note.remove(),4000);
    }
  </script>
</body>
</html>
