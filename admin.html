<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Admin Dashboard ‚Äî Multi-Level + Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
*{font-family:"Kanit",sans-serif;box-sizing:border-box;transition:all .3s;}
body{margin:0;background:var(--bg);color:var(--text);}
:root{
  --violet:#715aff;
  --bg:#f4f4f7;
  --text:#111;
  --card:#fff;
}
body.dark{--bg:#0d0d12;--text:#eee;--card:#1a1a24;}
header,aside{background:var(--card);}
header{display:flex;justify-content:space-between;align-items:center;
  padding:10px 20px;box-shadow:0 2px 5px rgba(0,0,0,.1);
  position:fixed;top:0;width:100%;z-index:1000;}
aside{position:fixed;top:60px;left:0;width:220px;height:100%;overflow:auto;
  box-shadow:2px 0 5px rgba(0,0,0,.1);}
main{margin-left:220px;padding:80px 20px;}
.btn{background:var(--violet);color:#fff;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;}
.btn:hover{opacity:.9;}
.card{background:var(--card);padding:15px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.1);margin-bottom:15px;}
.table{width:100%;border-collapse:collapse;}
.table th,.table td{padding:8px;border-bottom:1px solid #ddd;}
.table th{background:var(--violet);color:#fff;}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 16px;background:#333;color:#fff;
border-radius:8px;opacity:0;pointer-events:none;transition:opacity .3s;z-index:9999;}
.toast.show{opacity:1;}
#status-bar{position:fixed;bottom:0;right:0;background:#27ae60;color:#fff;padding:5px 10px;
font-size:13px;border-radius:8px 0 0 0;}
#notifyBtn{position:fixed;bottom:100px;right:20px;font-size:22px;border-radius:50%;width:48px;height:48px;}
#chatBtn{position:fixed;bottom:40px;right:20px;font-size:22px;border-radius:50%;width:48px;height:48px;}
#notificationBox{position:fixed;bottom:160px;right:20px;width:300px;max-height:400px;overflow:auto;
background:var(--card);box-shadow:0 0 10px rgba(0,0,0,.3);border-radius:10px;display:none;padding:10px;}
#chatBox{position:fixed;bottom:100px;right:20px;width:320px;max-height:500px;
background:var(--card);border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.3);display:none;flex-direction:column;}
#chatMessages{flex:1;overflow:auto;padding:10px;}
.chat-msg{margin:5px 0;padding:8px;border-radius:8px;max-width:80%;}
.chat-msg.me{background:#715aff;color:#fff;align-self:flex-end;}
.chat-msg.other{background:#eee;color:#000;}
#chatInput{display:flex;padding:8px;}
#chatInput input{flex:1;padding:6px;border-radius:8px;border:1px solid #ccc;}
#chatInput button{margin-left:8px;}
@media(max-width:768px){
  aside{position:static;width:100%;height:auto;display:flex;overflow:auto;}
  main{margin:0;padding:70px 10px;}
}
</style>
</head>
<body>
<header>
  <div><strong>Admin Dashboard</strong></div>
  <div class="right">
    <span id="userInfo"></span>
    <button id="toggleTheme" class="btn">üåô</button>
    <button id="logout" class="btn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
  </div>
</header>

<aside id="sidebar">
  <button class="btn" data-section="overview">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
  <button class="btn" data-section="users">üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
  <button class="btn" data-section="teams">üß≠ ‡∏ó‡∏µ‡∏°</button>
  <button class="btn" data-section="tasks">üìã ‡∏á‡∏≤‡∏ô</button>
  <button class="btn" data-section="reports">üßæ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
  <button class="btn" data-section="settings">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
</aside>

<main>
  <section id="overviewSection">
    <h2>üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
    <div class="card"><canvas id="overviewChart" height="150"></canvas></div>
    <div id="overviewStats"></div>
  </section>

  <section id="usersSection" style="display:none;">
    <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
    <table class="table" id="userTable"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th><th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody></tbody></table>
  </section>

  <section id="teamsSection" style="display:none;">
    <h2>üß≠ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡∏°</h2>
    <table class="table" id="teamTable"><thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</th><th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th></tr></thead><tbody></tbody></table>
  </section>

  <section id="tasksSection" style="display:none;">
    <h2>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h2>
    <table class="table" id="taskTable"><thead><tr><th>‡∏á‡∏≤‡∏ô</th><th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th><th>‡∏ó‡∏µ‡∏°</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody></tbody></table>
  </section>

  <section id="reportsSection" style="display:none;">
    <h2>üßæ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</h2>
    <canvas id="reportChart" height="200"></canvas>
  </section>

  <section id="settingsSection" style="display:none;">
    <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
    <button id="clearLocal" class="btn">üóë ‡∏•‡πâ‡∏≤‡∏á LocalStorage</button>
    <button id="backupData" class="btn">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  </section>
</main>

<!-- üîî Notification -->
<button id="notifyBtn" class="btn">üîî</button>
<div id="notificationBox"></div>

<!-- üí¨ Chat -->
<button id="chatBtn" class="btn">üí¨</button>
<div id="chatBox">
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input id="msgInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
    <button id="sendMsg" class="btn">‡∏™‡πà‡∏á</button>
  </div>
</div>

<div id="status-bar">üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, addDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } 
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyB_7tyj_BAyFzKEYVrZXfQjWCUXGS7VqKY",
  authDomain:"my-todo-list-9d2fa.firebaseapp.com",
  projectId:"my-todo-list-9d2fa",
  storageBucket:"my-todo-list-9d2fa.appspot.com",
  messagingSenderId:"631403892452",
  appId:"1:631403892452:web:66d382bf5f143fc05de6f1"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const toast=document.getElementById("toast");
function showToast(msg){toast.textContent=msg;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),3000);}

// ===== Auth Check =====
let adminLevel="staff", userData=null;
onAuthStateChanged(auth,async user=>{
  if(!user){window.location.href="admin-login.html";return;}
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()||snap.data().role!=="admin"){await signOut(auth);window.location.href="login.html";return;}
  userData=snap.data(); adminLevel=userData.adminLevel||"staff";
  document.getElementById("userInfo").textContent=`üë§ ${userData.name} (${adminLevel})`;
  adjustUI(adminLevel); initDashboard(); initNotification(user.uid); initChat(user.uid);
});

function adjustUI(level){
  if(level==="manager"){document.querySelector('[data-section="users"]').style.display="none";}
  if(level==="staff"){
    document.querySelector('[data-section="users"]').style.display="none";
    document.querySelector('[data-section="teams"]').style.display="none";
    document.querySelector('[data-section="settings"]').style.display="none";
    document.querySelectorAll(".btn").forEach(b=>b.disabled=true);
  }
}

// ===== Navigation =====
document.querySelectorAll("aside .btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("main section").forEach(s=>s.style.display="none");
    document.getElementById(btn.dataset.section+"Section").style.display="block";
  };
});
document.getElementById("logout").onclick=async()=>{await signOut(auth);window.location.href="admin-login.html";};

// ===== Theme =====
const body=document.body,btnTheme=document.getElementById("toggleTheme");
if(localStorage.getItem("theme")==="dark")body.classList.add("dark");
btnTheme.onclick=()=>{body.classList.toggle("dark");localStorage.setItem("theme",body.classList.contains("dark")?"dark":"light");};

// ===== Dashboard Overview =====
async function initDashboard(){
  const q=collection(db,"tasks");
  const docs=await getDocs(q);
  const total=docs.size,done=[...docs.docs].filter(d=>d.data().done).length;
  const ctx=document.getElementById("overviewChart");
  new Chart(ctx,{type:"doughnut",data:{labels:["‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"],
  datasets:[{data:[done,total-done],backgroundColor:["#715aff","#ccc"]}]}});

  document.getElementById("overviewStats").innerHTML=
  `<div class='card'>‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} | ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: ${done}</div>`;
  if(adminLevel!=="staff"){loadUsers();loadTeams();loadTasks();}
}

// ===== Users =====
async function loadUsers(){
  const tb=document.querySelector("#userTable tbody");tb.innerHTML="";
  const users=await getDocs(collection(db,"users"));
  users.forEach(u=>{
    const d=u.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${d.name}</td><td>${d.email}</td><td>${d.adminLevel||"-"}</td>
      <td>${adminLevel==="super"?`<button class='btn' data-uid='${d.uid}' data-action='del'>‡∏•‡∏ö</button>`:""}</td>`;
    tb.appendChild(tr);
  });
  if(adminLevel==="super"){
    tb.querySelectorAll("[data-action='del']").forEach(b=>{
      b.onclick=async()=>{if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?")){await deleteDoc(doc(db,"users",b.dataset.uid));showToast("‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß");loadUsers();}};
    });
  }
}

// ===== Teams =====
async function loadTeams(){
  const tb=document.querySelector("#teamTable tbody");tb.innerHTML="";
  const teams=await getDocs(collection(db,"teams"));
  teams.forEach(t=>{
    const d=t.data(); if(adminLevel!=="super"&&userData.teamId!==d.id)return;
    tb.innerHTML+=`<tr><td>${d.name}</td><td>${d.members?.length||0}</td></tr>`;
  });
}

// ===== Tasks =====
async function loadTasks(){
  const tb=document.querySelector("#taskTable tbody");tb.innerHTML="";
  const tasks=await getDocs(collection(db,"tasks"));
  tasks.forEach(t=>{
    const d=t.data(); if(adminLevel!=="super"&&d.teamId!==userData.teamId)return;
    tb.innerHTML+=`<tr><td>${d.title}</td><td>${d.ownerName||"-"}</td>
      <td>${d.teamId||"-"}</td><td>${d.done?"‚úÖ":"‚ùå"}</td></tr>`;
  });
}

// ===== Reports =====
document.querySelector('[data-section="reports"]').onclick=async()=>{
  const ctx=document.getElementById("reportChart");
  const tasks=await getDocs(collection(db,"tasks"));
  const done=[...tasks.docs].filter(t=>t.data().done).length;
  const total=tasks.size;
  new Chart(ctx,{type:"pie",data:{labels:["‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"],datasets:[{data:[done,total-done],backgroundColor:["#715aff","#aaa"]}]}})
};

// ===== Settings =====
document.getElementById("clearLocal").onclick=()=>{localStorage.clear();showToast("üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß");};
document.getElementById("backupData").onclick=async()=>{
  const all={users:[],teams:[],tasks:[]};
  const [u,t,ts]=await Promise.all([
    getDocs(collection(db,"users")),
    getDocs(collection(db,"teams")),
    getDocs(collection(db,"tasks"))
  ]);
  u.forEach(x=>all.users.push(x.data()));t.forEach(x=>all.teams.push(x.data()));ts.forEach(x=>all.tasks.push(x.data()));
  const blob=new Blob([JSON.stringify(all,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="backup.json";a.click();
  showToast("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß");
};

// ===== Notification =====
const notifyBtn=document.getElementById("notifyBtn");
const notifyBox=document.getElementById("notificationBox");
notifyBtn.onclick=()=>{notifyBox.style.display=notifyBox.style.display==="block"?"none":"block";};
function initNotification(uid){
  const q=query(collection(db,"notifications"),orderBy("timestamp","desc"));
  onSnapshot(q,snap=>{
    notifyBox.innerHTML="";
    snap.forEach(d=>{
      const n=d.data();
      if(n.to===uid){const div=document.createElement("div");
        div.textContent=n.message;
        div.style.padding="6px";div.style.borderBottom="1px solid #ccc";
        notifyBox.appendChild(div);
      }
    });
  });
}

// ===== Chat =====
const chatBtn=document.getElementById("chatBtn");
const chatBox=document.getElementById("chatBox");
const msgBox=document.getElementById("chatMessages");
const sendBtn=document.getElementById("sendMsg");
chatBtn.onclick=()=>{chatBox.style.display=chatBox.style.display==="flex"?"none":"flex";};
function initChat(uid){
  const q=query(collection(db,"teamChats"),orderBy("timestamp","asc"));
  onSnapshot(q,snap=>{
    msgBox.innerHTML="";
    snap.forEach(docSnap=>{
      const m=docSnap.data(); if(m.team!==userData.teamId)return;
      const div=document.createElement("div");
      div.className="chat-msg "+(m.from.uid===uid?"me":"other");
      div.textContent=m.from.name+": "+m.message;
      msgBox.appendChild(div);
    });
    msgBox.scrollTop=msgBox.scrollHeight;
  });
  sendBtn.onclick=async()=>{
    const txt=document.getElementById("msgInput");
    if(!txt.value)return;
    await addDoc(collection(db,"teamChats"),{
      team:userData.teamId,
      from:{uid:uid,name:userData.name},
      message:txt.value,
      timestamp:serverTimestamp()
    });
    txt.value="";
  };
}

// ===== Offline & Error =====
window.addEventListener("offline",()=>{document.getElementById("status-bar").textContent="üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå";});
window.addEventListener("online",()=>{document.getElementById("status-bar").textContent="üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå";});
window.onerror=(msg)=>{console.error(msg);showToast("‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");};
</script>
</body>
</html>
